import { createFileRoute, Link } from '@tanstack/react-router'
import EmptyList from '@/components/shared/empty-list'
import { LoadingSplash } from '@/components/shared/splash'
import { useAuth } from '@/contexts/AuthContext'
import { calculateAge } from '@/utils/calculate-age.util'
import { getInitials } from '@/utils/getInitials.util'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Clock, MessageCircle, CheckCheck } from 'lucide-react'

export const Route = createFileRoute('/_private/_app/chats/')({
	component: RouteComponent,
})

// Dados fict√≠cios de chats enriquecidos
const generateMockChatData = (profiles: any[]) => {
	return profiles.map((profile, index) => {
		const sessionId = `SESSION-${String(index + 1).padStart(4, '0')}`
		const lastMessageTime = new Date(Date.now() - Math.random() * 86400000) // √öltimas 24h
		const messageCount = Math.floor(Math.random() * 50) + 1

		const mockMessages = [
			{
				id: `MSG-${index}-001`,
				sender: profile.user.name,
				content: 'Oi! Como voc√™ est√°?',
				timestamp: new Date(lastMessageTime.getTime() - 3600000),
				isRead: true,
			},
			{
				id: `MSG-${index}-002`,
				sender: 'Voc√™',
				content: 'Oi! Tudo bem sim, e com voc√™?',
				timestamp: new Date(lastMessageTime.getTime() - 1800000),
				isRead: true,
			},
			{
				id: `MSG-${index}-003`,
				sender: profile.user.name,
				content: 'Tudo certo! Gostei muito de seu perfil üòä',
				timestamp: lastMessageTime,
				isRead: false,
			},
		]

		return {
			...profile,
			sessionId,
			lastMessageTime,
			messageCount,
			lastMessage: mockMessages[mockMessages.length - 1],
			messages: mockMessages,
			isOnline: Math.random() > 0.5,
		}
	})
}

const formatTimeAgo = (date: Date) => {
	const now = new Date()
	const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000)

	if (diffInSeconds < 60) return 'agora'
	if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`
	if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`
	return `${Math.floor(diffInSeconds / 86400)}d`
}

function RouteComponent() {
	const { firestoreUser, isFirestoreLoading } = useAuth()

	if (isFirestoreLoading) {
		return <LoadingSplash />
	}

	if (!Array.isArray(firestoreUser?.matches) || firestoreUser?.matches.length === 0) {
		return <EmptyList type="messages" />
	}

	const chatsEnhanced = generateMockChatData(firestoreUser.matches)

	return (
		<div className="container mx-auto mb-12 max-w-2xl p-4">
			<header className="mb-8 flex items-center justify-between">
				<div>
					<h1 className="font-bold text-3xl">Mensagens</h1>
					<p className="text-gray-600 text-sm mt-1">
						{chatsEnhanced.length} conversa{chatsEnhanced.length !== 1 ? 's' : ''}
					</p>
				</div>
				<div className="flex items-center gap-2">
					<MessageCircle className="w-5 h-5 text-blue-600" />
					<Badge variant="secondary">{chatsEnhanced.reduce((sum, c) => sum + c.messageCount, 0)}</Badge>
				</div>
			</header>

			{/* Tabela de chats enriquecida */}
			<div className="space-y-3">
				{chatsEnhanced.map((chat) => (
					<Link to="/" key={chat.id} className="group">
						<div className="rounded-xl bg-white p-4 shadow-md transition-all hover:shadow-lg hover:bg-gray-50 border border-gray-100">
							<div className="flex items-start gap-4">
								{/* Avatar com status */}
								<div className="relative shrink-0">
									<Avatar className="h-14 w-14">
										<AvatarImage src={chat.user.photos.find((p: any) => p.isPrimary)?.url || ''} />
										<AvatarFallback className="text-lg font-semibold">{getInitials(chat.user.name)}</AvatarFallback>
									</Avatar>
									{chat.isOnline && (
										<div className="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white" />
									)}
								</div>

								{/* Informa√ß√µes do chat */}
								<div className="min-w-0 flex-1">
									<div className="flex items-start justify-between mb-2">
										<div className="min-w-0">
											<h2 className="font-semibold text-gray-900 text-base group-hover:text-blue-600 transition-colors">
												{chat.user.name}
											</h2>
										</div>
										<span className="text-gray-500 text-xs shrink-0 ml-2 flex items-center gap-1">
											<Clock className="w-3 h-3" />
											{formatTimeAgo(chat.lastMessageTime)}
										</span>
									</div>

									{/* √öltima mensagem */}
									{/* <div className="bg-gray-50 rounded-lg p-3 mb-2 border border-gray-200"> */}
									{/* 	<p className="text-sm text-gray-700 truncate"> */}
									{/* 		<span className="font-medium text-gray-900">{chat.lastMessage.sender}:</span>{' '} */}
									{/* 		{chat.lastMessage.content} */}
									{/* 	</p> */}
									{/* </div> */}

									{/* Metadata do chat */}
									<div className="flex items-center justify-between gap-2">
										<div className="flex items-center gap-2">
											<Badge variant="outline" className="text-xs">
												{chat.messageCount} mensagens
											</Badge>
											{!chat.lastMessage.isRead && <Badge className="bg-blue-600 text-white text-xs">nova</Badge>}
										</div>
										<div className="flex items-center gap-1 text-gray-500">
											{chat.lastMessage.isRead ? (
												<CheckCheck className="w-4 h-4 text-blue-600" />
											) : (
												<MessageCircle className="w-4 h-4" />
											)}
										</div>
									</div>
								</div>
							</div>
						</div>
					</Link>
				))}
			</div>
		</div>
	)
}
